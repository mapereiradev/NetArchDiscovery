<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Escaneo de Red / Dispositivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mantén tu CSS original aquí -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* refuerzos mínimos por si faltan en tu CSS */
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    .row{display:flex;gap:1rem;flex-wrap:wrap}
    .col{flex:1 1 360px}
    .card{border:1px solid #334155;border-radius:10px;padding:1rem;background:#0b1020}
    .btn{background:#1f2937;color:#e5e7eb;border:1px solid #374151;padding:.5rem .75rem;border-radius:8px;cursor:pointer}
    .btn:hover{background:#374151}
    .muted{color:#94a3b8}
    .progress{height:8px;background:#1f2937;border-radius:6px;overflow:hidden}
    .bar{height:100%;background:#22c55e;width:0%}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #334155;padding:.5rem;text-align:left}
    th{background:#0f172a}
    .flash{padding:.5rem 1rem;border-radius:8px;margin:.5rem 0}
    .flash.error{background:#fee2e2;color:#7f1d1d}
    .flash.success{background:#dcfce7;color:#14532d}
  </style>
</head>
<body>
<div class="container">

  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% for cat, msg in msgs %}
      <div class="flash {{ cat }}">{{ msg }}</div>
    {% endfor %}
  {% endwith %}

  <header style="margin-bottom:1rem;">
    <h1>Escaneo de Red / Dispositivo</h1>
    <p class="muted">Lanza uno o varios escaneos en paralelo y sigue el progreso en tiempo real.</p>
  </header>

  <section class="card">
    <form id="scanForm" method="post" action="{{ url_for('main.api_scan') }}">
      <div class="row">
        <div class="col">
          <label for="target"><strong>IP / host / red</strong></label>
          <input id="target" type="text" name="target" placeholder="192.168.1.0/24, 10.0.0.12, host.local" style="width:100%;padding:.6rem;border-radius:8px;border:1px solid #334155;background:#0b1020;color:#e5e7eb">
          <p class="muted" style="margin:.25rem 0 0;">Para <code>nmap</code> es necesario indicar un objetivo. Para la enumeración local no es obligatorio.</p>
        </div>
        <div class="col">
          <fieldset style="border:1px solid #334155;border-radius:8px;padding:.75rem;">
            <legend class="muted">Herramientas (concurrentes)</legend>
            <label style="display:block;margin:.25rem 0;">
              <input type="checkbox" name="tools" value="local_enum" checked>
              Enumeración local (rutas, DNS, sockets, permisos)
            </label>
            <label style="display:block;margin:.25rem 0;">
              <input type="checkbox" name="tools" value="nmap" id="nmap">
              Nmap (-sV) sobre el objetivo indicado
            </label>
              <div id="nmap_opciones_avanzadas" style="display: none;">
               <legend>Opciones de Nmap Avanzadas</legend>

                <!-- Escaneos -->
                <label><input type="checkbox" name="opt_sT"> -sT (TCP Connect)</label>
                <label><input type="checkbox" name="opt_sU"> -sU (UDP Scan)</label>
                <label><input type="checkbox" name="opt_A"> -A (Full detection: OS, Version, Scripts, Traceroute)</label>
                <label><input type="checkbox" name="opt_sC"> -sC (Default scripts)</label>
                <label><input type="checkbox" name="opt_script_vuln"> --script=vuln (Check vulnerabilities)</label>

                <!-- Puertos -->
                <label>
                  <input type="checkbox" id="opt_ports_toggle"> Personalizar puertos
                </label>
                <div id="ports_options" style="display:none; margin-left:20px;">
                  <input type="text" name="opt_ports" placeholder="Ej: 22,80,443 o 0-65535">
                  <label><input type="checkbox" name="opt_F"> -F (100 puertos más comunes)</label>
                </div>

                <!-- Timing -->
                <label>
                  <input type="checkbox" id="opt_timing_toggle"> Ajustar velocidad (-T)
                </label>
                <div id="timing_options" style="display:none; margin-left:20px;">
                  <select name="opt_T">
                    <option value="0">-T0 (Paranoid)</option>
                    <option value="1">-T1 (Sneaky)</option>
                    <option value="2">-T2 (Polite)</option>
                    <option value="3" selected>-T3 (Normal)</option>
                    <option value="4">-T4 (Aggressive)</option>
                    <option value="5">-T5 (Insane)</option>
                  </select>
                </div>

                <!-- Resolución DNS -->
                <label><input type="checkbox" name="opt_n"> -n (No resolver DNS)</label>
              </div>
            <!-- deja aquí espacio para futuras herramientas: masscan, dns-reverse, etc. -->
          </fieldset>
        </div>
      </div>

      <div class="row" style="align-items:center; margin-top:.5rem;">
        <div class="col" style="flex:0 0 auto;">
          <button type="submit" class="btn">Iniciar escaneo</button>
        </div>
        <div class="col muted">Los resultados parciales se publican por eventos SSE.</div>
      </div>
    </form>
  </section>

  <section class="card">
    <h2 style="margin-top:0;">Trabajos recientes</h2>

    {% if jobs and jobs|length > 0 %}
      <table id="jobs-table">
        <thead>
          <tr>
            <th>Job</th>
            <th>Estado</th>
            <th>Progreso</th>
            <th>Herramientas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for j in jobs|reverse %}
          <tr id="row-{{ j.id }}">
            <td><code>{{ j.id[:8] }}</code></td>
            <td id="status-{{ j.id }}">{{ j.status }}</td>
            <td style="min-width:180px;">
              <div class="progress">
                <div id="bar-{{ j.id }}" class="bar" style="width: {{ j.progress }}%"></div>
              </div>
              <small id="pct-{{ j.id }}" class="muted">{{ j.progress }}%</small>
            </td>
            <td>{{ j.tools|join(", ") }}</td>
            <td>
              <a class="btn" href="{{ url_for('main.job_detail', job_id=j.id) }}">Detalle</a>
              {% if j.report_file %}
                <a class="btn" href="{{ url_for('main.get_report', name=j.report_file) }}">Informe</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No hay trabajos aún. Lanza el primero con el formulario de arriba.</p>
    {% endif %}
  </section>

  <section class="card">
    <h2 style="margin-top:0;">Reportes generados</h2>
    {% if reports and reports|length > 0 %}
      <ul id="reports-list" style="list-style:none;padding-left:0;">
        {% for r in reports %}
          <li style="margin:.25rem 0;">
            <a class="btn" href="{{ url_for('main.get_report', name=r.name) }}">{{ r.name }}</a>
            <small class="muted"> — {{ r.path }}</small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Aún no hay reportes. Aparecerán aquí al finalizar los jobs.</p>
    {% endif %}
  </section>

</div>

<script>
(function(){
  /* === Plantillas de URL renderizadas por Jinja (con placeholders) === */
  const REPORT_URL_TMPL     = "{{ url_for('main.get_report', name='__NAME__') }}";
  const JOB_DETAIL_URL_TMPL = "{{ url_for('main.job_detail', job_id='__ID__') }}";

  // ---- Toggling de opciones Nmap (con defensivos) ----
  const nmapChk = document.getElementById("nmap");
  const adv = document.getElementById("nmap_opciones_avanzadas");
  if (nmapChk && adv){
    const setAdv = () => adv.style.display = nmapChk.checked ? "block" : "none";
    nmapChk.addEventListener("change", setAdv);
    setAdv();
  }
  const pt = document.getElementById("opt_ports_toggle");
  const ptBox = document.getElementById("ports_options");
  if (pt && ptBox){
    const setPorts = () => ptBox.style.display = pt.checked ? "block" : "none";
    pt.addEventListener("change", setPorts);
    setPorts();
  }
  const tt = document.getElementById("opt_timing_toggle");
  const ttBox = document.getElementById("timing_options");
  if (tt && ttBox){
    const setTiming = () => ttBox.style.display = tt.checked ? "block" : "none";
    tt.addEventListener("change", setTiming);
    setTiming();
  }

  // ---- Helpers UI existentes ----
  function setProgress(jobId, pct){
    const bar = document.getElementById("bar-"+jobId);
    const txt = document.getElementById("pct-"+jobId);
    if(bar){ bar.style.width = (pct|0)+"%"; }
    if(txt){ txt.textContent = (pct|0)+"%"; }
  }
  function setStatus(jobId, status){
    const el = document.getElementById("status-"+jobId);
    if(el){ el.textContent = status; }
  }

  // ---- NUEVO: crear la tabla si aún no existe (primer job) ----
  function ensureJobsTable(){
    let table = document.getElementById("jobs-table");
    if (table) return table.tBodies[0];

    // Busca la card de "Trabajos recientes" (es la segunda en tu layout)
    const cards = document.querySelectorAll('section.card');
    const jobsCard = cards[1] || document.body;

    // Quita el <p> “No hay trabajos…” si existe
    const emptyP = jobsCard.querySelector("p.muted");
    if (emptyP) emptyP.remove();

    // Crea la tabla
    const wrapper = document.createElement("div");
    wrapper.innerHTML = `
      <table id="jobs-table">
        <thead>
          <tr>
            <th>Job</th>
            <th>Estado</th>
            <th>Progreso</th>
            <th>Herramientas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>`;
    jobsCard.appendChild(wrapper.firstElementChild);
    return document.querySelector("#jobs-table tbody");
  }

  // ---- NUEVO: ensureRow que usa la tabla dinámica ----
  function ensureRow(job){
    const job_id = String(job.id);
    let row = document.getElementById("row-"+job_id);

    // Asegura que existe la tabla (la crea si falta)
    const tbody = ensureJobsTable();
    if (!tbody) return;

    if (row) {
      // si ya existe, actualiza herramientas si vinieron luego
      const tc = document.getElementById("tools-"+job_id);
      if (tc && job.tools && job.tools.length) tc.textContent = job.tools.join(", ");
      return;
    }

    const detallesLink = JOB_DETAIL_URL_TMPL.replace("__ID__", encodeURIComponent(job_id));

    row = document.createElement("tr");
    row.id = "row-"+job_id;
    row.innerHTML = `
      <td><code>${job_id.slice(0,8)}</code></td>
      <td id="status-${job_id}">${job.status || "running"}</td>
      <td style="min-width:180px;">
        <div class="progress"><div id="bar-${job_id}" class="bar" style="width:${job.progress||0}%"></div></div>
        <small id="pct-${job_id}" class="muted">${job.progress||0}%</small>
      </td>
      <td id="tools-${job_id}">${(job.tools||[]).join(", ")}</td>
      <td class="actions">
        <a class="btn" href="${detallesLink}">Detalle</a>
      </td>`;
    tbody.prepend(row);
  }

  // ---- Enlaces de informe (fila + lista) ----
  function addReportLink(jobId, reportName){
    const row = document.getElementById("row-"+jobId);
    if(!row) return;
    const cell = row.querySelector("td.actions") || row.lastElementChild; // fallback
    if(!cell) return;
    if (cell.querySelector(`[data-report="${CSS.escape(reportName)}"]`)) return;
    const a = document.createElement("a");
    a.className = "btn";
    a.href = REPORT_URL_TMPL.replace("__NAME__", encodeURIComponent(reportName));
    a.textContent = "Informe";
    a.setAttribute("data-report", reportName);
    cell.appendChild(a);
  }

  function addReportToList(name){
    const ul = document.getElementById("reports-list");
    if(!ul) return;
    if (ul.querySelector(`[data-report="${CSS.escape(name)}"]`)) return;
    const li = document.createElement("li");
    li.setAttribute("data-report", name);
    li.innerHTML = `<a class="btn" target="_blank" href="${REPORT_URL_TMPL.replace("__NAME__", encodeURIComponent(name))}">${name}</a>`;
    ul.prepend(li);
  }

  // ---- Carga inicial de informes ya existentes (opcional) ----
  document.addEventListener("DOMContentLoaded", async () => {
    const ul = document.getElementById("reports-list");
    if(!ul) return;
    try {
      const res = await fetch("{{ url_for('main.api_reports') }}");
      const data = await res.json();
      (data.files || []).forEach(addReportToList);
    } catch (_) {}
  });

  // ---- Normalizador para sacar job_id del evento ----
  function getJobId(d, e){
    // 1) del payload
    if (d && d.job_id) return d.job_id;
    // 2) de meta (compat)
    if (d && d.meta && d.meta.job_id) return d.meta.job_id;
    // 3) de lastEventId (si se usa)
    const id = (e && e.lastEventId || "").trim();
    return id || null;
  }

  /* === SSE global (tu bloque, con el extra de añadir reportes a la lista) === */
  const src = new EventSource("{{ url_for('main.events') }}");

  src.addEventListener("status", e => {
    try{
      const d = JSON.parse(e.data);
      const jobId = getJobId(d, e);
      if(!jobId) return;

      ensureRow({id: jobId, status: d.status, progress: 0, tools: d.tools || []});
      setStatus(jobId, d.status);
      if (d.status === "done") setProgress(jobId, 100);

      if (d.report){
        addReportLink(jobId, d.report);
        addReportToList(d.report);
      }
    }catch(_){}
  });

  src.addEventListener("progress", e => {
    try{
      const d = JSON.parse(e.data); // {progress, job_id}
      const jobId = getJobId(d, e);
      if(!jobId) return;
      ensureRow({id: jobId, status: "running", progress: d.progress, tools: []});
      setProgress(jobId, d.progress);
    }catch(_){}
  });

  src.addEventListener("log", e => { /* logs no se muestran en listado */ });

  src.addEventListener("finished", e => {
    try{
      const d = JSON.parse(e.data);
      const jobId = getJobId(d, e);
      if(jobId){
        setStatus(jobId, "done");
        setProgress(jobId, 100);
      }
    }catch(_){}
  });

  // ---- Envío AJAX del formulario para NO redirigir ----
  const form = document.getElementById("scanForm");
  if(form){
    form.addEventListener("submit", async function(ev){
      ev.preventDefault();

      // desactiva botón mientras envía
      const btn = form.querySelector('button[type="submit"]');
      if (btn){ btn.disabled = true; btn.textContent = "Lanzando…"; }

      try{
        const fd = new FormData(form);
        const res = await fetch(form.action, {
          method: "POST",
          body: fd,
          credentials: "same-origin",
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });

        let data = null;
        try { data = await res.json(); } catch { /* si viene HTML por error */ }

        if(!res.ok || !data || !data.job_id){
          const msg = (data && data.error) ? data.error : `Error al iniciar el escaneo (${res.status})`;
          alert(msg);
          return;
        }

        // pinta fila inicial; el SSE la seguirá actualizando
        ensureRow({id: data.job_id, status: "running", progress: 0, tools: data.tools || []});

        // resalta la fila recién creada
        const row = document.getElementById("row-"+data.job_id);
        if(row){ row.style.outline = "2px solid #60a5fa"; setTimeout(()=> row.style.outline="", 1200); }

      }catch(err){
        console.error(err);
        alert("No se pudo lanzar el escaneo (conexión o servidor).");
      }finally{
        if (btn){ btn.disabled = false; btn.textContent = "Iniciar escaneo"; }
      }
    });
  }
})();
</script>


</body>
</html>