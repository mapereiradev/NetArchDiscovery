<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Escaneo de Red / Dispositivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mantén tu CSS original aquí -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* refuerzos mínimos por si faltan en tu CSS */
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    .row{display:flex;gap:1rem;flex-wrap:wrap}
    .col{flex:1 1 360px}
    .card{border:1px solid #334155;border-radius:10px;padding:1rem;background:#0b1020}
    .btn{background:#1f2937;color:#e5e7eb;border:1px solid #374151;padding:.5rem .75rem;border-radius:8px;cursor:pointer}
    .btn:hover{background:#374151}
    .muted{color:#94a3b8}
    .progress{height:8px;background:#1f2937;border-radius:6px;overflow:hidden}
    .bar{height:100%;background:#22c55e;width:0%}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #334155;padding:.5rem;text-align:left}
    th{background:#0f172a}
    .flash{padding:.5rem 1rem;border-radius:8px;margin:.5rem 0}
    .flash.error{background:#fee2e2;color:#7f1d1d}
    .flash.success{background:#dcfce7;color:#14532d}
  </style>
</head>
<body>
<div class="container">

  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% for cat, msg in msgs %}
      <div class="flash {{ cat }}">{{ msg }}</div>
    {% endfor %}
  {% endwith %}

  <header style="margin-bottom:1rem;">
    <h1>Escaneo de Red / Dispositivo</h1>
    <p class="muted">Lanza uno o varios escaneos en paralelo y sigue el progreso en tiempo real.</p>
  </header>

  <section class="card">
    <form id="scanForm" method="post" action="{{ url_for('main.api_scan') }}">
      <div class="row">
        <div class="col">
          <label for="target"><strong>IP / host / red</strong></label>
          <input id="target" type="text" name="target" placeholder="192.168.1.0/24, 10.0.0.12, host.local" style="width:100%;padding:.6rem;border-radius:8px;border:1px solid #334155;background:#0b1020;color:#e5e7eb">
          <p class="muted" style="margin:.25rem 0 0;">Para <code>nmap</code> es necesario indicar un objetivo. Para la enumeración local no es obligatorio.</p>
        </div>
        <div class="col">
          <fieldset style="border:1px solid #334155;border-radius:8px;padding:.75rem;">
            <legend class="muted">Herramientas (concurrentes)</legend>
            <label style="display:block;margin:.25rem 0;">
              <input type="checkbox" name="tools" value="local_enum" checked>
              Enumeración local (rutas, DNS, sockets, permisos)
            </label>
            <label style="display:block;margin:.25rem 0;">
              <input type="checkbox" name="tools" value="nmap" id="nmap">
              Nmap (-sV) sobre el objetivo indicado
            </label>
              <div id="nmap_opciones_avanzadas" style="display: none;">
               <legend>Opciones de Nmap Avanzadas</legend>

                <!-- Escaneos -->
                <label><input type="checkbox" name="opt_sT"> -sT (TCP Connect)</label>
                <label><input type="checkbox" name="opt_sU"> -sU (UDP Scan)</label>
                <label><input type="checkbox" name="opt_A"> -A (Full detection: OS, Version, Scripts, Traceroute)</label>
                <label><input type="checkbox" name="opt_sC"> -sC (Default scripts)</label>
                <label><input type="checkbox" name="opt_script_vuln"> --script=vuln (Check vulnerabilities)</label>

                <!-- Puertos -->
                <label>
                  <input type="checkbox" id="opt_ports_toggle"> Personalizar puertos
                </label>
                <div id="ports_options" style="display:none; margin-left:20px;">
                  <input type="text" name="opt_ports" placeholder="Ej: 22,80,443 o 0-65535">
                  <label><input type="checkbox" name="opt_F"> -F (100 puertos más comunes)</label>
                </div>

                <!-- Timing -->
                <label>
                  <input type="checkbox" id="opt_timing_toggle"> Ajustar velocidad (-T)
                </label>
                <div id="timing_options" style="display:none; margin-left:20px;">
                  <select name="opt_T">
                    <option value="0">-T0 (Paranoid)</option>
                    <option value="1">-T1 (Sneaky)</option>
                    <option value="2">-T2 (Polite)</option>
                    <option value="3" selected>-T3 (Normal)</option>
                    <option value="4">-T4 (Aggressive)</option>
                    <option value="5">-T5 (Insane)</option>
                  </select>
                </div>

                <!-- Resolución DNS -->
                <label><input type="checkbox" name="opt_n"> -n (No resolver DNS)</label>
              </div>
            <label style="display:block;margin:.25rem 0;">
              <input type="checkbox" name="tools" value="dns_reverse">
                DNS inversa (PTR) del target
            </label>
            <!-- deja aquí espacio para futuras herramientas: masscan, dns-reverse, etc. -->
          </fieldset>
        </div>
      </div>

      <div class="row" style="align-items:center; margin-top:.5rem;">
        <div class="col" style="flex:0 0 auto;">
          <button type="submit" class="btn">Iniciar escaneo</button>
        </div>
        <div class="col muted">Los resultados parciales se publican por eventos SSE.</div>
      </div>
    </form>
  </section>

  <section class="card">
    <h2 style="margin-top:0;">Trabajos recientes</h2>

    {% if jobs and jobs|length > 0 %}
      <table id="jobs-table">
        <thead>
          <tr>
            <th>Job</th>
            <th>Estado</th>
            <th>Progreso</th>
            <th>Herramientas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for j in jobs|reverse %}
          <tr id="row-{{ j.id }}">
            <td><code>{{ j.id[:8] }}</code></td>
            <td id="status-{{ j.id }}">{{ j.status }}</td>
            <td style="min-width:180px;">
              <div class="progress">
                <div id="bar-{{ j.id }}" class="bar" style="width: {{ j.progress }}%"></div>
              </div>
              <small id="pct-{{ j.id }}" class="muted">{{ j.progress }}%</small>
            </td>
            <td>{{ j.tools|join(", ") }}</td>
            <td>
              <a class="btn" href="{{ url_for('main.job_detail', job_id=j.id) }}">Detalle</a>
              {% if j.report_file %}
                <a class="btn" href="{{ url_for('main.get_report', name=j.report_file) }}">Informe</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No hay trabajos aún. Lanza el primero con el formulario de arriba.</p>
    {% endif %}
  </section>

  <section class="card">
    <h2 style="margin-top:0;">Reportes generados</h2>
    {% if reports and reports|length > 0 %}
      <ul id="reports-list" style="list-style:none;padding-left:0;">
        {% for r in reports %}
          <li style="margin:.25rem 0;">
            <a class="btn" href="{{ url_for('main.get_report', name=r.name) }}">{{ r.name }}</a>
            <small class="muted"> — {{ r.path }}</small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Aún no hay reportes. Aparecerán aquí al finalizar los jobs.</p>
    {% endif %}
  </section>

</div>

<script>
  window.APP_ROUTES = {
    EVENTS_URL: "{{ url_for('main.events') }}",
    API_REPORTS_URL: "{{ url_for('main.api_reports') }}",
    API_SCAN_URL: "{{ url_for('main.api_scan') }}",
    JOB_DETAIL_URL_TMPL: "{{ url_for('main.job_detail', job_id='__ID__') }}",
    REPORT_URL_TMPL: "{{ url_for('main.get_report', name='__NAME__') }}"
  };
</script>
<script src="{{ url_for('static', filename='js/scanning.js') }}"></script>


</body>
</html>